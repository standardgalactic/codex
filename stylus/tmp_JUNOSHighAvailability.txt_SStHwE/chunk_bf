
Note
Much like earlier topics in this chapter, the key to
          maintaining high availability is thorough planning and design,
          attention to detail during reconfiguration, and vigilance in
          monitoring.






Tunneling



When merging companies together, it is not always possible, at least
        in the short term, to have the desired physical connectivity between
        networks. When this happens in OSPF networks, virtual links provide the connectivity
        required to allow the network to function, as shown in Figure 19-14.









Figure 19-14. Merged OSPF networks using virtual links



Note
Virtual links are generally not recommended as a permanent
          solution for OSPF networks.

Another option to extend the network is through general
        tunneling technologies. Generic Route
        Encapsulation (GRE) is a solution that can be helpful in extending and
        joining networks by allowing discontiguous areas to appear directly
        connected, despite not being physically connected. For example, the
        two networks' OSPF backbones could be connected using GRE, creating a
        single joined backbone despite the lack of direct physical
        connectivity.






Other Options for Merging IGPs



Sometimes it is simply not feasible to join the networks together,
      either in the short term or ever. In these cases, other options might be
      appropriate.




BGP



In certain cases, it might make sense to continue to treat the networks as
        separate entities. Perhaps there will never be a good solution to
        physically join them together, or perhaps each company's IT department
        will continue to manage its own network. In such a situation, an
        appropriate solution may be to keep the networks separate and join
        them using BGP. Regardless of whether direct physical connectivity is
        available, BGP can provide excellent routing and policy control
        between the networks, while providing the desired connectivity. BGP
        also provides a variety of high availability features for this
        scenario, such as redundant routing and failover options, as we
        discuss in Chapter 20.





Routing instances



In rare cases, connectivity may be available but for some reason it is
        still desirable to keep the networks separate. In this situation, the
        solution may be to use the multiple routing instance feature of JUNOS
        Software. This solution allows a router to join the networks together
        without requiring that they actually merge. A
        router positioned at the edge of both networks can run two separate
        routing instances and can send each network's routes to the other
        network. This effectively provides route redistribution between
        identical IGPs, allowing sharing of routing information without
        altering either network's architecture.

Note
While not an ideal method of joining networks together, using
          routing instances is functional and you can use it as a short-term
          solution in certain cases.
















Chapter 20. Merging BGP Autonomous Systems



It would be nice to be able to plan your network from scratch, taking into account
  scalability, of course, and to never have to worry about dealing with
  mergers, or kludges, or one-offs, but that never happens. Sometimes you will
  be required to bring another network into the fold no matter how messed up
  you perceive the other network to be.
Although the migration of the Interior Gateway Protocol (IGP) is vital
  to internal connectivity, errors in Border Gateway Protocol (BGP) can lead
  not only to internal routing issues, but also to external routing issues
  that could thrust your network into the listserv annals of groups such as
  the North American Network Operators Group, which researches, comments on,
  and, if necessary, sanctions networks affecting Internet routing, or the
  high availability posture of networks managed by NANOG members.
With careful planning and use of the tools built into JUNOS, it is
  possible to safely merge Autonomous Systems (ASs) and not only protect your
  network's uptime, but also mitigate any risk to the high availability of
  your upstream and downstream neighbors.













Planning the Merge



Unlike the realm of IGPs, where religious wars rage between the noble followers of
    Open Shortest Path First (OSPF) and heretics of Intermediate System to
    Intermediate System (IS-IS), or vice versa, interdomain routing sits in a
    realm where only a single protocol rules. Tomes in all forms of media have
    been devoted to BGP, and there is no shortage of information available to
    use to develop a plan for merging networks, including BGP,
    by Iljitsch van Beijnum (O'Reilly), and Internet Routing
    Architectures, by Sam Halabi (Cisco Press).




Architecture



Like most of the other topics covered in this book, planning
      the architecture for BGP in ASs is normally not a greenfield effort.
      There are few, if any, large networks that do not already have a BGP
      architecture. In terms of operating, merging, or maintaining a BGP
      network, planning is key. It is necessary not only to look to the future
      to see what design is best for scalability, but also to determine which
      design will merge most easily and scale most efficiently.
According to RFC 1771, all Internal BGP (IBGP) peers must be fully meshed within the AS to prevent
      routing loops. Using the full mesh has the advantage of ensuring that
      all routers in the AS have the same topology information. The
      disadvantage comes with the configuration and scalability of the IBGP
      peering. To avoid these issues, the following additional BGP
      architectures have been created:



Confederations


The division on an AS into multiple sub-ASs with a full mesh
            required only in the sub-AS. When confederations are used, the
            communication across the sub-AS boundaries is called Confederation
            Border Gateway Protocol (CBGP). CBGP is a slightly modified form of External BGP
            (EBGP) peering.


Route reflection


The use of multiple routers as a focal point for routing
            updates so that most IBGP peers peer only to the route
            reflectors.







Making the choice



When merging ASs, you must fully understand the advantages and
        possible trade-offs of each type of architecture. Though both route
        reflection and confederations solve the full-mesh issues, each has its
        own peculiarities. Table 20-1
        compares the options for IBGP peering.


Table 20-1. Comparing IBGP peering options











Feature


Full
                mesh


Route
                reflection


Confederations






Hierarchical
                roles


None


Uses route reflector
                and route reflector
                clients


None formally, but
                through architectural design, some sub-ASs may work as
                backbones




Topology


All BGP peers are fully
                meshed; issues of n * (n -
                1)/2 occur


AS is divided into
                clusters made up of route reflectors and their clients; an AS
                can contain routers but not within the clusters


AS becomes a
                confederation of sub-ASs
                made up of fully peered BGP neighbors; within the sub-AS, all
                peers must be peered




Configuration and
                peering


All BGP routers are
                configured to peer with all other BGP peers; JUNOS allows for
                "dynamic" peering to reduce the configuration of
                peers


Clients are peered to
                route reflectors and route reflectors are fully meshed;
                cluster IDs are used to differentiate between route reflector
                groupings


Sub-ASs are configured
                with their own ID; within the sub-AS, all peers are fully
                meshed




Communications between
                peers


IBGP is used between
                all peers


IBGP is used between
                route reflectors and clients; route reflectors use IBGP with
                added attributes for peering


IBGP is used between
                all peers within a sub-AS; CBGP is used between all sub-ASs and uses slightly
                modified EBGP attributes for the AS-path attribute, local preference, next hop,
                and MED handling




Changes or additions to
                the BGP attributes


Standard
                BGP

Additional mandatory
                attributes passed within AS: Originator ID (Type
                9) Cluster ID (Type 10)
AS-path attribute enhancements passed within AS and
                between sub-ASs:
Type 3: AS Confederation Set Type 4: AS
                Confederation Sequence



Handling of next hop
                attribute, local
                preference, and MED


By design, next hop,
                local preference, and MED
                are not changed between IBGP peers


By design, next hop,
                local preference, and MED
                are not changed between IBGP peers; thus, there is no change
                between route reflectors or route reflectors and
                clients


Though CBGP is
                "EBGP-like," the next hop is not changed between CBGP peers,
                and the local preference and MED are preserved; IBGP within the
                sub-AS follows the full-mesh IBGP rules




Default propagation of
                learned prefix


IBGP speakers readvertise only those prefixes
                learned from EBGP


Route reflectors
                readvertise only routes learned from EBGP or clientsâ€”and only to other
                nonclient peers; route reflectors readvertise EBGP or nonclient
                peer-learned routes to client peers


IBGP speakers
                readvertise only prefixes learned from
                EBGP




Use of multihop
                parameter


Not
                needed


Not
                needed


Because CBGP is based
                on EBGP, if an IP address other than interface addresses are
                used, multihop may be necessary











Pitfalls



There are many possible pitfalls when attempting to determine
        how to architect a newly formed AS made up of merged ASs. In most
        networks, the full mesh is instantly discounted because of the
        complexity of its maintenance, but most people overlook the problem
        of persistent route oscillation when
        dealing with route reflectors and confederations. RFC 3345, "BGP Persistent Route Oscillation Condition,"
        focuses on the two types of churn resulting from route reflection and confederation and how to prevent
        them. Figure 20-1 illustrates an AS
        that uses route reflection and accepts multi-exit discriminators from
        its peers.









Figure 20-1. Churn in route reflection


Using RFC 3345 as a guide, the following sections illustrate how
        a situation such as this would result in persistent route
        oscillation.

Note
The route oscillation caused by issues such as these can
          result in networks being
          advertised, withdrawn, and readvertised within 10 seconds. Although some ignore this
          issue, calling it a "minor inconvenience," any persistent issues in
          routing or routing table functions can lead to network downtime.
          Simple best practices and due diligence can eliminate this issue
          when you are dealing with providing high availability.






External peering



Looking at Figure 20-1, as
        the routes for 192.168.0.0/16 are advertised from AS 350
        through AS 150 and AS 250 and are then received by AS 50, a MED attribute is
        attached and advertised. The routers that are peered
        externallyâ€”CL, CL1, and CL2â€”receive the routes from external
        neighbors and view the routing topology for 192.168.0.0/16 as shown in
        Table 20-2.


Table 20-2. CL, CL1, and CL2 topology table










Router


MED


AS_PATH







CL



1


250 350





CL1



10


150 350





CL2



20


250 350






Because these routers are the external facing routers, the IGP
        metric is of no concern in the route decision-making process.





Route reflector 1



The routes that CL1 and CL2 learn are readvertised to the route
        reflector, which in this case is RR1. Using the MED,
        RR1 creates the information shown in Table 20-3 for
        192.168.0.0/16.


Table 20-3. Route reflector 1 routing table












Best path


AS_PATH


MED


NEXT_HOP

NEXT_HOP IGP cost





*


150 350


20



CL1



27



 

250 350


10



CL2



25






The issue with this routing decision is that the IGP cost to
        CL1 is greater than to CL2; therefore, internal to the AS, CL2 is the best next hop for packets. BGP
        corrects the routing table within RR1 and sends an update message to RR2 highlighting CL2 as the best next hop for
        192.168.0.0/16.





Route reflector 2



When RR2 receives the
        updates, the information that is received is used to recalculate the
        next hop against its own table. Using the MED,
        RR1 creates the information in Table 20-4 for
        192.168.0.0/16.


Table 20-4. Route reflector 2 routing table












Best
                path


AS_PATH


MED


NEXT_HOP

NEXT_HOP IGP
                cost





*


150 350


1



CL1



50



 

150 350


10



CL2



45






Once again, you can see the issue is that the IGP cost for the
        next hop is less than that of the route currently considered to be the
        best path. Of course, this has to be changed; it is, and RR2 sends a withdraw message to RR1 informing it that the path chosen is not
        the best next hop.





Oscillation commences



This withdraw message is received by RR1 and the next hop is again calculated
        using the MED as the
        determining factor for the best path. Because the MED has not changed, RR1 recalculates the best path and creates
        the routing information shown in Table 20-5.


Table 20-5. Route reflector 1 routing table












Best
                path


AS_PATH


MED


NEXT_HOP

NEXT_HOP IGP
                cost





*


150 350


20



CL1



27



 

250 350


10



CL2



25






With the recalculation, the routing information is back to where
        it was in the first step. At this point, BGP must correct its routes
        again and the route thrashing begins. This thrashing of routes
        continues until either the MED or
        the IGP cost is changed in such a way as to make a single route
        preferable.






Outcomes



Of course, the main goal of merging ASs is to have all the equipment fall
      under the same administrative control. However, you must consider many
      underlying issues. Here are a few questions you should ask:



Will traffic bound for company1 pass through the same ingress
          point into the new company1/company2 AS, or will routing be diverted
          such that all traffic passes through combined ingress points?


During the merger, will a new AS be used for the merged
          network and, if so, how will the AS numbers of the two ASs be
          used?


Will peering change in such a way that it affects routing or
          creates routing churn in the Internet in general?


How is the new network to be viewed externally? Will it
          maintain a look of autonomy for each network being merged, or will
          the new merged network appear as a single AS externally?








BGP Migration Features in JUNOS



As part of the planning process, we must examine JUNOS features that can
      smooth the process of merging ASs. This section discusses features
      related to the operation of BGP, the routing engine (RE), and JUNOS
      software that ease AS mergers and reduce downtime.




Graceful Restart



Graceful Restart (GR) in routing protocols allows hiccups in network routing to
        occur without resulting in network downtime. The forgiving nature of
        GR allows network mergers to proceed without the route flapping,
        peering issues, and forwarding delays that can accompany peering
        disruption. If a peering session flags during the merger, with GR
        other peers can assist the flapping router to relearn the network
        topology without affecting packet forwarding.
GR is disabled by default. You can configure it for BGP to
        negotiate GR information with BGP peers. The equipment to which the
        network device peers must also support GR, as those devices will be
        the ones helping the peer to relearn its routes.
Here is the basic configuration for GR:

routing-options {
    graceful-restart;
}
protocols {
    bgp {
        graceful-restart {
            restart-time 300;
            stale-routes-time 600;
        }
    }
}
You must configure GR globally in the routing-options hierarchy,
        and the restart-time and stale-routes-time must be configured in
        either the main BGP instance or the BGP instances of logical
        routers.





Non-Stop Active Routing



Using the same foundations as GR, Non-Stop Active
        Routing (NSR) allows redundant REs to communicate routing information so that if the
        master fails, the redundant RE picks up the slack without BGP peers
        even noticing that the original RE has failed. In JUNOS, you can use
        NSR with IPv4 and IPv6 to ensure that high availability is maintained
        even if the network merger causes a routing protocol burp.
Here is the basic configuration for NSR:

chassis {
    redundancy {
        graceful-switchover;
    }
}
routing-options {
    nonstop-routing;
}
Because NSR provides a graceful failover between REs, you must have redundant REs
        installed and configured for failover. The graceful-switching statement is required in
        the chassis hierarchy to ensure that failover works correctly.





Full mesh made easy (well, easier)



Because of IBGP's full-mesh architecture, when you add a new IBGP peer to the network, you must add the
        peer information on every other BGP speaker on the network. This is
        where the simplicity of a full-mesh architecture to prevent routing
        loops is overridden by the complexity of the configuration. Also,
        because you need to make these changes throughout the network, even on
        the EBGP routers, there is a risk of networkwide downtime
        caused by human error.
To help mitigate this massive reconfiguration for new peers,
        JUNOS introduced the concept of "dynamic" BGP peers. The allow command within BGP groups allows new peering relationships to
        be implicitly formed based on IP address ranges. This allows older
        systems to learn of new peers without requiring their reconfiguration.
        Figure 20-2 illustrates the addition of
        routers into an IBGP full mesh. This expansion can be the result of
        either a merger or simple expansion.
In phase 1 of the illustration, you configure the full mesh very
        simply, using the loopback addresses. You explicitly call out the IP
        address of the peer in the configuration. Including the allow statement means you can add new peers
        to the network without having to reconfigure the existing
        infrastructure.
On router EBGP-Peer:

protocols {
    bgp {
        group EBGP {
            type external;
            neighbor 10.0.0.2;
            peer-as 100;
        }
        group IBGP{
            type internal;
            allow 192.168.1.0/24;
            neighbor 192.168.1.2;
        }
    }
}
On router IBGP-Peer-1:

protocols {
    bgp {
        }
        group IBGP{
            type internal;
            allow 192.168.1.0/24;
            neighbor 192.168.1.1;
        }
    }
}









Figure 20-2. Expanding the full mesh


The following code snippet shows the configuration on a newly
        added router, IBGP-Peer-2:

protocols {
